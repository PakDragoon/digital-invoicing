generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ────────────────────────────────────────────────
// Global Schema
// ────────────────────────────────────────────────

model AdminUser {
  id         BigInt      @id @default(autoincrement())
  email      String      @unique
  hashpass   String
  fullName   String
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  userTokens UserToken[] @relation("AdminUserTokens")
}

// ────────────────────────────────────────────────
// Tenant Schema
// ────────────────────────────────────────────────

model Company {
  id                  BigInt   @id @default(autoincrement())
  companyName         String
  phone               String
  addressStreet1      String
  addressStreet2      String
  city                String
  state               String
  zipCode             String
  countryCode         String
  fbrDevToken         String?
  fbrToken            String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  employees           User[]
  invoices            Invoice[]
}

model Role {
  id              BigInt   @id @default(autoincrement())
  roleName        RoleName @unique
  roleDescription String
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  employees       User[]
}

model User {
  id              BigInt     @id @default(autoincrement())
  companyId    BigInt
  roleId          BigInt
  email           String     @unique
  hashpass        String
  firstName       String
  lastName        String
  phone           String
  isActive        Boolean
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  company    Company    @relation(fields: [companyId], references: [id])
  role          Role          @relation(fields: [roleId], references: [id])
  userTokens    UserToken[]

  @@unique([companyId, email])
}

model UserToken {
  id           BigInt   @id @default(autoincrement())
  companyId   BigInt?
  employeeId   BigInt?
  adminUserId  BigInt?
  accessToken  String
  refreshToken String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  employee   User?   @relation(fields: [employeeId], references: [id])
  adminUser  AdminUser?  @relation("AdminUserTokens", fields: [adminUserId], references: [id])
}

model Invoice {
  id                    BigInt   @id @default(autoincrement())
  companyId             BigInt
  fbrInvoiceId          String?  // Invoice ID returned from FBR API
  invoiceType           String
  invoiceDate           String
  invoiceRefNo          String
  scenarioId            String
  
  // Seller Information
  sellerNTNCNIC         String
  sellerBusinessName    String
  sellerProvince        String
  sellerAddress         String
  
  // Buyer Information
  buyerRegistrationType String
  buyerNTNCNIC          String
  buyerBusinessName     String
  buyerProvince         String
  buyerAddress          String
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  company               Company      @relation(fields: [companyId], references: [id])
  items                 InvoiceItem[]
  
  @@unique([companyId, invoiceRefNo])
}

model InvoiceItem {
  id                              BigInt   @id @default(autoincrement())
  invoiceId                       BigInt
  hsCode                          String
  productDescription              String?
  rate                            String?
  uoM                             String
  quantity                        Decimal
  valueSalesExcludingST           Decimal
  salesTaxApplicable              Decimal?
  furtherTax                      Decimal?
  fedPayable                      Decimal?
  discount                        Decimal?
  fixedNotifiedValueOrRetailPrice Decimal?
  saleType                        String
  totalValues                     Decimal?
  salesTaxWithheldAtSource        Decimal?
  extraTax                        String?
  sroScheduleNo                   String?
  sroItemSerialNo                 String?
  
  createdAt                       DateTime @default(now())
  updatedAt                       DateTime @updatedAt
  
  invoice                         Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

enum RoleName {
  SuperAdmin
  Admin
  User
}
